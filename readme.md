# 车辆回放系统思路

忽略掉现有的项目里的所有文件，那是先前测试用的，实际需要根据下文完全重写。

前置工作

1. 使用 open.mp 的 npc 分支（相当于 FCNPC 的重写）的 github actions 构建的组件（除非已合并到主分支并发布版本）。
   1. 这样不需要 samp-npc，也就意味着不需要依赖 npcmodes 文件夹和空数据包。
2. 使用 raknet 组件模拟 npc 发送/拦截玩家数据包。

回放思路

1. 创建一个 npc 回放池子，简单点不考虑动态添加删除的话，就在游戏模式初始时创建对应池子数量的 npc
2. 设计 api 可主动控制 npc 的出生状态（回放前/后，实际玩家掉线/死亡等），回放单个数据等。
3. 屏蔽掉所有已出生的 npc 池子的 CarSync/FootSync 数据包(return false) EmulateIncomingPacket 不会进入到这个回调中。

录制思路

1. 拦截玩家 OnFoot/InCar Sync 数据包，存储位置、速度等数据，简单点就不支持拖车，也就是忽略 TrailerSync 数据。
2. 可能需要存在时间敏感/不敏感事件，具体看怎么设计高性能存储和读取 io ，低磁盘占用，支持前进/后退/变速，怎么找最近的一条同步更新上去
   1. 影响前进/后退，如车辆创建/销毁/model,颜色,车牌变更，玩家掉线重连，世界内部空间变动，textdraw/cp 等创建/销毁/数据更新...
   2. 考虑通过 tick 机制实现录制和回放（意味着需要注意异步，比如回放已经实现玩家开车到终点但是实际还有 nextTick 的数据包没执行完？）
   3. 暂停时需重复循环某一些tick范围内的数据以保证npc原地移动而不是停止

其他事项

1. 每一次主动前进/后退都要销毁掉比如之前的某些逻辑创建的 cp 点，textdraw,3dtext 等……
2. 技术手段无法主动设置真实玩家的 CarSync 或 FootSync，如果想实现主动操控玩家的车辆，只能让 npc 接管主驾
   1. 玩家坐在副驾，等 npc 接管完再把玩家放回主驾
   2. 这里面又牵扯到多人抢占一辆车的现有的座位等...

## License

[MIT](./LICENSE) License © 2022-PRESENT Carl You
